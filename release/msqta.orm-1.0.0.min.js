var MSQTA=MSQTA||{};MSQTA._IndexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,MSQTA._IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,MSQTA._IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,MSQTA._Errors={get:function(e,t){throw Error('MSQTA-ORM: get: missing search value on "'+t+'" schema from the "'+e+'" database!')},getByIndexWithRange1:function(e,t,n){throw Error('MSQTA-ORM: getByIndexWithRange: "'+n+'" is not an index in the "'+t+'" schema from the "'+e+'" database!')},getByIndexWithRange2:function(e){throw Error('MSQTA-ORM: getByIndexWithRange: operator "'+e+'" is not a valid one! You must use one of these: >, <, >=, <=, =')},getByIndexWithRange3:function(e,t,n,r){throw Error('MSQTA-ORM: getByIndexWithRange: comparator value "'+n+'" has been casted to a non-value:',r,' on "'+t+'" schema from the "'+e+'" database!')},getByIndexWithRange4:function(){throw Error("MSQTA-ORM: getByIndexWithRange: comparator data has an invalid set of comparision operators!")},getByIndexWithRange5:function(){throw Error("MSQTA-ORM: getByIndexWithRange: your range (>|>=) && (<|<=) is invalid!")},getByCallback:function(e,t){throw Error('MSQTA-ORM: getByCallback: missing callback function on "'+t+'" schema from the "'+e+'" database!')},getByIndex1:function(e,t,n){throw Error('MSQTA-ORM: getByIndex: "'+n+'" is not an index in the "'+t+'" schema from the "'+e+'" database!')},getByIndex2:function(e,t){throw Error('MSQTA-ORM: getByIndex: missing search value in "getByIndex" method from "'+t+'" schema from the "'+e+'" database!')},getWithLike1:function(){throw Error('MSQTA-ORM: getWithLike: like data is not valid, it must be something like this: "{type: "both", value: "john"}" !')},getWithLike2:function(e,t,n){throw Error('MSQTA-ORM: getWithLike: unknown "'+n+'" column on the "'+t+'" schema from the "'+e+'" database!')},set1:function(e,t,n){throw Error('MSQTA-ORM: set: data param is invalid for the "'+t+'" schema from the "'+e+'" database!',n)},set2:function(e,t,n){throw Error('MSQTA-ORM: set: data to be set is invalid for the "'+t+'" schema from the "'+e+'" database!',n)},set3:function(e,t,n){throw Error('MSQTA-ORM: set: target data to be set is invalid for the "'+t+'" schema from the "'+e+'" database!',n)},set4:function(e,t,n,r,i){throw Error('MSQTA-ORM: set: comparator value "'+r+'" of the field "'+n+'" has been casted to a non-value:',r,' on "'+t+'" from the "'+e+'" database!')},set5:function(e,t,n,r,i){throw Error('MSQTA-ORM: set: new value "'+r+'" of the field "'+n+'" has been casted to a non-value:',i,' on "'+t+'" from the "'+e+'" database!')},del1:function(e,t){throw Error('MSQTA-ORM: del: schema "'+t+'" from the "'+e+'" database has not a primary key setted up!')},del2:function(e,t){throw Error('MSQTA-ORM: del: missing id(s) param to make the deletion in "'+t+'" schema from the "'+e+'" database!')},del3:function(e,t,n,r){throw Error('MSQTA-ORM: del: comparator value "'+n+'" has been casted to a non-value:',r,' on "'+t+'" from the "'+e+'" database!')},batch1:function(e,t){throw Error("MSQTA-ORM: batch: data param is invalid:",t,' on the "'+e+'" database!')},batch2:function(e){throw Error("MSQTA-ORM: batch: supplied Schema:",e," is not a instance of MSQTA")},batch3:function(e){throw Error('MSQTA-ORM: batch: type method "'+e+'" is incorrect, the valid ones are: put, set and del')}},MSQTA._Helpers={noop:function(){},defaultCallback:function(){console.log("MSQTA-ORM: default callback used: results:",arguments[0])},webSQLSize:2097152,getCaster:function(e){return e==="object"||e==="array"?this.castObj:e==="datetime"?this.castDateTime:e==="date"?this.castDate:e==="time"?this.castTime:e==="boolean"?this.castBoolean:this.castGeneric},castObj:function(e){return JSON.parse(e)},castDate:function(e){var t=e.split("-");return new Date(t[0],t[1]-1,t[2],0,0,0,0)},castTime:function(e){var t=new Date,n=e.split(":");return t.setHours(n[0]),t.setMinutes(n[1]),t.setSeconds(n[2]),t},castDateTime:function(e){var t=e.split(" "),n=t[0].split("-"),r=t[1].split(":");return new Date(n[0],n[1]-1,n[2],r[0],r[1],r[2],0)},castBoolean:function(e){return!!e},castGeneric:function(e){return e},ormMethods:["batch","destroy"],schemaMethods:["del","destroy","empty","get","getAll","getWithLike","getByCallback","getByIndex","getByIndexWithRange","put","set"],dimSchemaInstance:function(e){var t=this.schemaMethods,n=this.noop,r,i;for(r=0,i=t.length;r<i;r++)e[t[r]]=n},dimORMInstance:function(e){var t=this.ormMethods,n=this.schemaMethods,r,i,s,o=this.noop,u,a;for(u=0,a=t.length;u<a;u++)e[t[u]]=o;s=e._Schemas;for(r in s){i=s[r];for(u=0,a=n.length;u<a;u++)i[n[u]]=o}},getORMPrototype:function(e){e=e.toLowerCase();if(e==="websql"){if(window.openDatabase)return MSQTA._ORM.WebSQL}else if(e==="indexeddb"&&MSQTA._IndexedDB)return MSQTA._ORM.IndexedDB;if(window.openDatabase)return MSQTA._ORM.WebSQL;if(MSQTA._IndexedDB)return MSQTA._ORM.IndexedDB},instantiateSchema:function(e){var t=e.ORM,n=e.schemaPrototype,r=e.implementation,i=e.schemaDefinition,s=e.args,o={},u;if(!t)throw Error("MSQTA-ORM: Schema: missing new keyword at initializing a schema");return typeof s[1]=="function"?(o.callback=s[1],o.context=s[2]||window):typeof s[1]=="object"&&(o=s[1]),MSQTA._Schema.prototype=n,u=new MSQTA._Schema(t,i,o),u._resetSchemaAt=MSQTA._Helpers.resetSchemaAt,u._getValueBySchema=MSQTA._Helpers.getValueBySchema,u._implementation=r,u._init(),u},getValueBySchema:function(e,t){var n=this._schemaFields,r=this._name,i=n[e];if(!i)throw Error('MSQTA-ORM: unknown column "'+e+'" in the "'+r+'" schema!');return i.sanitizer(t,i.zero)},supportedDataTypes:{string:"TEXT",integer:"INTEGER",object:"TEXT",array:"TEXT",date:"DATE",time:"TIME",datetime:"DATETIME","float":"REAL","boolean":"INTEGER"},webSQLZeros:{string:'""',integer:0,object:'"{}"',array:'"[]"',date:'"0000-00-00"',time:'"00:00:00"',datetime:'"0000-00-00 00:00:00"',"float":0,"boolean":0},indexedDBZeros:{string:"","int":0,integer:0,text:"",object:{},array:[],date:new Date(0,0,0),time:new Date(0,0,0),datetime:new Date(0,0,0),"float":0,"boolean":!1},resetSchemaAt:function(e){var t=this._implementation,n=MSQTA._Helpers.supportedDataTypes,r=t==="webSQL"?MSQTA._Helpers.webSQLZeros:MSQTA._Helpers.indexedDBZeros,i=this._name,s=this._ORM._name,o=this._schemaFields[e],u,a=o.type,f=n[a],l=o.allowNull;if(!f)throw Error('MSQTA-ORM: column "'+e+'" with the data type "'+a+'" is invalid/not supported in the "'+i+'" schema from the "'+s+'" database!');u=this._schemaFields[e],u.zero=l?t==="webSQL"?"null":null:r[a],u.sanitizer=t==="webSQL"?MSQTA._Helpers.WebSQLSanitizers.getSanitizer(a):MSQTA._Helpers.IndexedDBSanitizers.getSanitizer(a),u.toJS=MSQTA._Helpers.getCaster(a),u.isDate=a==="date"||a==="time"||a==="datetime",t==="webSQL"&&(u.abstract=a,u.real=f+(l?" NULL":""),u.isJSON=a==="object"||a==="array")}},MSQTA._Helpers.WebSQLSanitizers={getSanitizer:function(e){if(e==="string"||e==="text")return this.sanitizeString;if(e==="int"||e==="integer"||e==="float")return this.sanitizeInt;if(e==="object"||e==="array")return this.sanitizeObj;if(e==="date")return this.sanitizeDate;if(e==="time")return this.sanitizeTime;if(e==="datetime")return this.sanitizeDatetime;if(e==="boolean")return this.sanitizeBoolean},sanitizeString:function(e,t){return e?'"'+(e+"").replace(/"/g,'\\"')+'"':t},sanitizeInt:function(e,t){return e-=0,e?e:t},sanitizeDate:function(e,t){var n,r;return e instanceof Date&&+e>=0?(n=e.getMonth()+1,r=e.getDate(),'"'+e.getFullYear()+"-"+(n<10?"0"+n:n)+"-"+(r<10?"0"+r:r)+'"'):(n=/^(\d{4}-\d{2}-\d{2})(?: \d{2}:\d{2}(?::\d{2}))?$/.exec(e),n?'"'+n[1]+'"':t)},sanitizeTime:function(e,t){if(e instanceof Date&&+e>=0)return'"'+e.toTimeString().substring(0,8)+'"';var n=/^(?:\d{4}-\d{2}-\d{2} )?(\d{2}:\d{2})(:\d{2})?$/.exec(e);return n?'"'+n[1]+(n[2]||":00")+'"':t},sanitizeDatetime:function(e,t){var n,r;return e instanceof Date&&+e>=0?(n=e.getMonth()+1,r=e.getDate(),'"'+e.getFullYear()+"-"+(n<10?"0"+n:n)+"-"+(r<10?"0"+r:r)+" "+e.toTimeString().substring(0,8)+'"'):(n=/^(\d{4}-\d{2}-\d{2})(?: |T)(\d{2}:\d{2})(?:(:\d{2})[^Z]+Z|(:\d{2}))?$/.exec(e),n?'"'+n[1]+" "+n[2]+(n[3]||n[4]||":00")+'"':t)},sanitizeObj:function(e,t){if(typeof e=="undefined")return t;if(typeof e!="object")return e?typeof e=="string"?"'"+e+"'":e:t;try{return"'"+JSON.stringify(e)+"'"}catch(n){return t}},sanitizeBoolean:function(e,t){return typeof e=="string"?(e=e.toLowerCase(),e==="true"||e==="1"?1:e==="false"||e==="0"?0:t):e===1?1:e===0?0:t},sanitizeGeneric:function(e){return e}},MSQTA._Helpers.IndexedDBSanitizers={getSanitizer:function(e){if(e==="string"||e==="text")return this.sanitizeString;if(e==="int"||e==="integer"||e==="float")return this.sanitizeInt;if(e==="object"||e==="array")return this.sanitizeObj;if(e==="date")return this.sanitizeDate;if(e==="time")return this.sanitizeTime;if(e==="datetime")return this.sanitizeDatetime;if(e==="boolean")return this.sanitizeBoolean},sanitizeString:function(e,t){return e?e+"":t},sanitizeInt:function(e,t){return e-=0,e?e:t},sanitizeDate:function(e,t){var n,r;return e instanceof Date&&!isNaN(e-0)?(e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),e):(n=/^(\d{4}-\d{2}-\d{2})(?: \d{2}:\d{2}(?::\d{2}))?$/.exec(e),n?(n=n[1].split("-"),new Date(n[0],n[1]-1,n[2],0,0,0,0)):t)},sanitizeTime:function(e,t){if(e instanceof Date&&!isNaN(e-0))return e;var n=/^(\d{4}-\d{2}-\d{2} )?(\d{2}:\d{2})(:\d{2})?$/.exec(e);if(!n)return t;var r,i,s;return n[1]?(r=n[1].split("-"),r[1]=r[1]-1):(r=new Date,r=[r.getFullYear(),r.getMonth(),r.getDate()]),i=n[2].split(":"),s=n[3]||0,new Date(r[0],r[1],r[2],i[0],i[1],s,0)},sanitizeDatetime:function(e,t){var n,r;if(e instanceof Date&&!isNaN(e-0))return e;n=/^(\d{4}-\d{2}-\d{2})(?: |T)(\d{2}:\d{2})(?::(\d{2})[^Z]+Z|:(\d{2}))?$/.exec(e);if(!n)return t;var i,s,o;return i=n[1].split("-"),s=n[2].split(":"),o=n[3]||n[4]||0,new Date(i[0],i[1]-1,i[2],s[0],s[1],o,0)},sanitizeObj:function(e,t){return typeof e=="undefined"?t:typeof e!="object"?e?typeof e=="string"?"'"+e+"'":e:t:e},sanitizeBoolean:function(e,t){return typeof e=="string"?(e=e.toLowerCase(),e==="true"||e==="1"?!0:e==="false"||e==="0"?!1:t):e===1?!0:e===0?!1:t},sanitizeGeneric:function(e){return e}},MSQTA.ORM=function(e,t,n){typeof e=="string"&&(e={name:e});if(!e.name)throw Error("MSQTA-ORM: not database name has been specify!");return e.callback=typeof t=="function"?t:MSQTA._Helpers.defaultCallback,e.context=n||window,MSQTA._ORM.prototype=MSQTA._Helpers.getORMPrototype(e.prefered||""),new MSQTA._ORM(e)},MSQTA._ORM=function(e){var t=this._name=e.name;this.devMode=e.devMode||!1,this.forceDestroy=e.forceDestroy,this._queries=[],this._Schemas={},this._batchsStack=[],this.Schema._ORM=this,this._isBlocked=!0,this._schemasToInit=[],this._initCallback=e.callback,this._initContext=e.context,this.forceDestroy?(this.devMode&&console.log('MSQTA-ORM: "forceDestroy" flag detected for the "'+t+'" database, initializing process, tthen it will recreate again'),this._deleteUserDatabase(this._open,this)):this._open()},MSQTA._Schema=function(e,t,n){var r=e._name,i=t.name;if(e._Schemas[i])throw Error('MSQTA-Schema: "'+i+'" schema already exists on the "'+r+'" database!');var s=t.fields;if(typeof s!="object"||!Object.keys(s).length)throw Error('MSQTA-Schema: "'+i+'" schema definition of the "'+r+'" database is invalid!');var o=t.primaryKey;if(!o||o&&!s[o])throw Error('MSQTA-Schema: primary key referes to a non-exisistent fieldName in the "'+i+'" schema from the "'+r+'" database!');if(s[o].type!=="integer")throw Error('MSQTA-Schema: primary key must be of integer type on "'+i+'" schema from the "'+r+'" database!');s[o].allowNull=!0;var u,a,f=[],l=[];for(u in s){a=s[u];if(a.index){if(!/^(integer|float|string|date|time|datetime)$/.test(a.type))throw Error('MSQTA-Schema: index type must be of the type: integer|float|string|date|time|datetime, on "'+i+'" schema from the "'+r+'" database!');f.push(u)}else a.index=!1;a.unique?(f.indexOf(u)===-1&&f.push(u),l.push(u)):a.unique=!1}e._Schemas[i]=this,this._ORM=e,this.devMode=e.devMode,this._name=i,this._schemaFields=s,this._indexes=f,this._uniques=l,this._primaryKey=o,this._fieldsName=Object.keys(s),this.forceDestroy=n.forceDestroy,this.forceEmpty=this.forceDestroy?!1:n.forceEmpty,this._initCallback=typeof n.callback=="function"?n.callback:MSQTA._Helpers.defaultCallback,this._initContext=n.context||window},MSQTA._ORM.IndexedDB={Schema:function(e){return MSQTA._Helpers.instantiateSchema({ORM:this.constructor._ORM,schemaPrototype:MSQTA._Schema.IndexedDB,schemaDefinition:e,implementation:"indexedDB",args:arguments})},_open:function(){this.devMode&&console.log('MSQTA-ORM: opening the testigo database "__msqta__"');var e=this,t=this._name,n=MSQTA._IndexedDB.open("__msqta__",1);n.onupgradeneeded=function(t){var n=t.target.result,r;e.devMode&&console.log('MSQTA-ORM: creating the schema for the testigo database "__msqta__" for the first time and never again'),r=n.createObjectStore("databases",{keyPath:"id",autoIncrement:!0}),r.createIndex("name","name",{unique:!0}),n.createObjectStore("dump")},n.onsuccess=function(n){var r=n.target.result,i=r.transaction(["databases"],MSQTA._IDBTransaction.READ_WRITE),s=i.objectStore("databases");s.index("name").get(t).onsuccess=function(n){var i=n.target.result;if(!i)e.devMode&&console.log('MSQTA-ORM: database "'+t+'" is a new one, saving its metadata (branch and schema definition) in testigo "__msqta__" database'),e._currentBranch=0,s.add({name:t,branch:0,schemas:{}}).onsuccess=function(t){r.close(),e._init()};else{r.close();var o=i.branch;e.devMode&&console.log('MSQTA-ORM: database "'+t+'" is already created, its current branch (version number) is: '+o),e._currentBranch=o,e._init()}}},n.onerror=function(e){this._initCallback.call(this._initContext,null)}},_init:function(){this.devMode&&console.log('MSQTA-ORM: "'+this._name+'" database has been created!'),this._initCallback.call(this._initContext,!0),this._initSchemas()},_deleteUserDatabase:function(e,t){var n=this,r=this._name,i=MSQTA._IndexedDB.deleteDatabase(r);i.onsuccess=function(s){i=MSQTA._IndexedDB.open("__msqta__"),i.onsuccess=function(i){var s=i.target.result,o=s.transaction(["databases"],MSQTA._IDBTransaction.READ_WRITE),u=o.objectStore("databases");u.index("name").get(r).onsuccess=function(r){var i=r.target.result;u.delete(i.id).onsuccess=function(r){s.close(),MSQTA._Helpers.dimORMInstance(n),e.call(t||window,!0)}}}},i.onerror=function(n){e.call(t||window,!1)}},_initSchema:function(e){this._schemasToInit.push(e),this._isBlocked||this._initSchemas()},_initSchemas:function(){var e=this,t=this._name,n;this._schemasToInit.length?(n=MSQTA._IndexedDB.open("__msqta__",1),n.onsuccess=function(n){var r=n.target.result,i=r.transaction(["databases"],MSQTA._IDBTransaction.READ_WRITE),s=i.objectStore("databases");s.index("name").get(t).onsuccess=function(t){var n=t.target.result;e._initSchemas2(r,s,n)}},n.onerror=this._initSchemaFail):this._endSchemasInitialization()},_initSchemas2:function(e,t,n){var r=this,i=this._name,s=this._schemasToInit.shift(),o=s._name,u=n.schemas[o],a={fields:s._schemaFields,primaryKey:s._primaryKey};this._currentSchema=s,u?s.forceDestroy?(this.devMode&&console.log('MSQTA-ORM: "forceDestroy" flag detected: destroying the "'+o+'" schema from the database "'+i+'", then it will recreate again'),this._updateSchema3(this._updateSchema6)):s.forceEmpty?(this.devMode&&console.log('MSQTA-ORM: "forceEmpty" flag detected: emptying the "'+o+'" schema from the database "'+i+'"'),this._updateSchema7()):(this.devMode&&console.log('MSQTA-ORM: checking for changes in the schema "'+o+'" schema from the database "'+i+'"'),e.close(),this._checkSchemaChanges(u,a)?(this.devMode&&console.log("	new changes has been detected, proceeding to update its schema!"),this._updateSchema()):(this.devMode&&console.log("	no new changes has been detected!"),this._nextSchemaToInit())):(this._updateUserDatabaseRecord(t,n),e.close(),this._createSchema())},_checkSchemaChanges:function(e,t){var n=!1,r=e.fields,i=t.fields,s,o;for(fieldName in r){s=r[fieldName],o=i[fieldName];if(!o||s.type!==o.type||s.index!==o.index||s.unique!==o.unique){n=!0;break}}var u=e.primaryKey,a=t.primaryKey;return!n&&(u&&(!a||u!==a)||!u&&a)&&(n=!0),n},_updateUserDatabaseRecord:function(e,t){var n=this._currentSchema,r=n._name,i=n._primaryKey,s=n._schemaKeepTrack;return t.schemas[r]={fields:s,primaryKey:i},req=e.put(t),req},_createSchema:function(){var e=this,t=this._currentSchema,n=this._name,r=t._name,i=this._openUserDatabaseForChanges();i.onupgradeneeded=function(t){var i=t.target.result;e.devMode&&console.log('MSQTA-ORM: proceeding to create the schema "'+r+'" for the "'+n+'" database'),e._createSchemaForReal(i)},i.onsuccess=function(t){var n=t.target.result;n.close(),e._saveBranch(e._nextSchemaToInit,e)},i.onerror=this._initSchemaFail},_updateSchema:function(){var e=this,t=MSQTA._IndexedDB.open("__msqta__",1);t.onsuccess=function(t){var n=t.target.result,r=n.transaction(["dump"],MSQTA._IDBTransaction.READ_WRITE),i=r.objectStore("dump");i.clear().onsuccess=function(t){n.close(),e._updateSchema2()}},t.onerror=this._initSchemaFail},_updateSchema2:function(){var e=this,t=this._currentSchema,n=t._name,r=this._name,i=0,s=!1,o,u;this.devMode&&console.log("	(1) saving temporaly all records from the schema in the testigo database");var a=function(){var t=e._openUserDatabase();t.onsuccess=function(e){u=e.target.result;var t=u.transaction([n],MSQTA._IDBTransaction.READ_ONLY),r=t.objectStore(n);r.openCursor().onsuccess=f},t.onerror=this._initSchemaFail},f=function(e){var t=e.target.result;t?s?(l(t.value),s=!1,u.close()):i===0?(l(t.value),i++,u.close()):(t.advance(i),i++,s=!0):(u.close(),h())},l=function(t){var n=MSQTA._IndexedDB.open("__msqta__",1);n.onsuccess=function(n){o=n.target.result;var r=o.transaction(["dump"],MSQTA._IDBTransaction.READ_WRITE),s=r.objectStore("dump");e.devMode&&console.log(t),s.add(t,i).onsuccess=c},n.onerror=this._initSchemaFail},c=function(e){o.close(),a()},h=function(){e._updateSchema3(e._updateSchema4)};a()},_updateSchema3:function(e){var t=this,n=this._currentSchema,r=n._name,i=this._name,s=this._openUserDatabaseForChanges();s.onupgradeneeded=function(e){var n=e.target.result;t.devMode&&console.log("	(2) re-creating schema, we need to drop it and create it again with the newly schema"),n.deleteObjectStore(r),t._createSchemaForReal(n)},s.onsuccess=function(n){var r=n.target.result;r.close(),t.devMode&&console.log("	(3) saving new branch of modified database"),t._saveBranch(e,t)},s.onerror=this._initSchemaFail},_updateSchema4:function(){var e=this,t=this._currentSchema,n=t._name,r=t._schemaFields,i=this._name,s,o,u=!1,a=0;e.devMode&&console.log("	(4) restoring and recasting the saved temporaly records (if there any) to the recenlty updated schema");var f=function(){var e=MSQTA._IndexedDB.open("__msqta__",1);e.onsuccess=function(e){s=e.target.result;var t=s.transaction(["dump"],MSQTA._IDBTransaction.READ_ONLY),n=t.objectStore("dump");n.openCursor().onsuccess=l},e.onerror=this._initSchemaFail},l=function(e){var t=e.target.result;t?u?(c(t.value),u=!1,s.close()):a===0?(c(t.value),a++,s.close()):(t.advance(a),a++,u=!0):(s.close(),p())},c=function(t){var i=e._openUserDatabase();i.onsuccess=function(i){o=i.target.result;var s=o.transaction([n],MSQTA._IDBTransaction.READ_WRITE),u=s.objectStore(n),a,f,l;for(a in t)f=r[a],f?t[a]=f.sanitizer(t[a],f.zero):delete t[a];e.devMode&&console.log(t),l=u.put(t),l.onsuccess=h,l.onerror=h},i.onerror=this._initSchemaFail},h=function(e){o.close(),f()},p=function(){e._updateSchema5()};f()},_updateSchema5:function(){var e=this,t=this._name,n;n=MSQTA._IndexedDB.open("__msqta__",1),n.onsuccess=function(t){var n=t.target.result,r=n.transaction(["dump"],MSQTA._IDBTransaction.READ_WRITE),i=r.objectStore("dump");e.devMode&&console.log("	(5) deleting the temporaly saved records"),i.clear().onsuccess=function(t){n.close(),e._updateSchema6()}},n.onerror=this._initSchemaFail},_updateSchema6:function(){var e=this,t=this._name,n=this._currentSchema,r=n._name,i;i=MSQTA._IndexedDB.open("__msqta__",1),i.onsuccess=function(n){var r=n.target.result,i=r.transaction(["databases"],MSQTA._IDBTransaction.READ_WRITE),s=i.objectStore("databases");s.index("name").get(t).onsuccess=function(t){var n=t.target.result,i;e.devMode&&console.log("	(6) update schema information on testigo database to keep tracking future changes"),i=e._updateUserDatabaseRecord(s,n),i.onsuccess=function(t){r.close(),e._updateSchema8()}}},i.onerror=this._initSchemaFail},_updateSchema7:function(){var e=this,t=this._name,n=this._currentSchema,r=n._name,i;i=this._openUserDatabase(),i.onsuccess=function(t){var n=t.target.result,i=n.transaction([r],MSQTA._IDBTransaction.READ_WRITE),s=i.objectStore(r);s.clear().onsuccess=function(t){e._updateSchema8()}},i.onerror=this._initSchemaFail},_updateSchema8:function(){this.devMode&&console.log("	(7) update schema process is done"),this._nextSchemaToInit()},_initSchemaFail:function(){this._nextSchemaToInit(!1)},_createSchemaForReal:function(e){var t=this._currentSchema,n=t._schemaFields,r=t._name,i=t._primaryKey,s,o,u,a;this.devMode&&console.log("	primary key: "+i),a=e.createObjectStore(r,{keyPath:i,autoIncrement:!0});for(s in n)o=n[s],o.index&&(u=o.unique,this.devMode&&console.log("	index: "+s+(u?" (unique)":"")),a.createIndex(s,s,u?{unique:!0}:{}))},_nextSchemaToInit:function(e){var t=this._currentSchema,n=t._initCallback,r=t._initContext;n.call(r,typeof e=="undefined"?!0:e),delete t._initCallback,delete t._initContext,delete this._currentSchema,this._initSchemas()},_endSchemasInitialization:function(){this._isBlocked=!1},_saveBranch:function(e,t){var n=this,r=this._name,i=this._currentBranch,s;s=MSQTA._IndexedDB.open("__msqta__",1),s.onsuccess=function(s){var o=s.target.result,u=o.transaction(["databases"],MSQTA._IDBTransaction.READ_WRITE),a=u.objectStore("databases");a.index("name").get(r).onsuccess=function(s){var u=s.target.result;n.devMode&&console.log('MSQTA-ORM: saving branch (version number) from the database "'+r+'" to: '+i),u.branch=i,a.put(u),o.close(),e&&e.call(t||window)}}},_openUserDatabaseForChanges:function(){var e=this._name,t=this._currentBranch+1;return this.devMode&&console.log('MSQTA-ORM: opening "'+e+'" at branch: '+t+" to make schema changes"),this._currentBranch=t,MSQTA._IndexedDB.open(e,t)},_openUserDatabase:function(){var e=this._name,t=this._currentBranch;return this.devMode&&console.log('MSQTA-ORM: opening "'+e+'" at branch: '+t),MSQTA._IndexedDB.open(e,t)},_preExec:function(e){e.callback||(e.callback=MSQTA._Helpers.defaultCallback),e.context||(e.context=window),this._queries.push(e);if(this._isWaiting)return;this._isWaiting=!0,this._exec()},_exec:function(){var e=this,t=this._queries.shift(),n=this._name,r=t.schema,i=t.type,s;i==="destroy"?this._destroy(t):(s=this._openUserDatabase(),s.onsuccess=function(n){var s=n.target.result;i=t.type,transaction=s.transaction([r],MSQTA._IDBTransaction.READ_WRITE),objectStore=transaction.objectStore(r),t.objectStore=objectStore,t.database=s,e.devMode&&console.log('MSQTA-ORM: "'+r+'" schema will be manipulate ('+i+") with the data (may be undefined):",t.data),e["_"+i](t)})},_continue:function(){this._isWaiting=!1,this._queries.length&&this._exec()},_done:function(e,t){e.database.close(),e.callback.call(e.context,t),this._continue()},_put:function(e){var t=this,n=e.objectStore,r=e.data,i=0,s=r.length,o=function(n){i===s?t._done(e,n):(u(),i++)},u=function(){var e=r[i],t=n.add(e);t.onsuccess=function(e){o(e.target.result)},t.onerror=function(e){o(null)}};o()},_set:function(e){var t=this,n=e.objectStore,r=e.data,i=e.indexes,s=e.primaryKey,o=0,u=0,a=r.length,f=function(){u===a?t._done(e,o):(l(),u++)},l=function(){var e=r[u],t=e.data,i=e.target,a=i[s],l,c=Object.keys(i).length;a?n.get(a).onsuccess=function(e){var r=e.target.result,i;for(l in t)r[l]=t[l];i=n.put(r),i.onsuccess=function(e){e.target.result&&o++,f()},i.onerror=function(e){f(null)}}:n.openCursor().onsuccess=function(e){var n=e.target.result;if(n){var r=n.value,s=0,u;for(l in i)r[l]===i[l]&&s++;if(s===c){for(l in t)r[l]=t[l];u=n.update(r),u.onsuccess=function(e){e.target.result&&o++,n.continue()},u.onerror=function(e){n.continue()}}else n.continue()}else f()}};f()},_del:function(e){var t=this,n=e.objectStore,r=e.data,i=e.primaryKey,s=0,o=0,u=r.length,a=function(){o===u?t._done(e,s):(f(),o++)},f=function(){var e=r[o];n.delete(e[i]).onsuccess=function(e){e.target.result&&s++,a()}};a()},_empty:function(e){var t=this,n,r=e.objectStore;r.count().onsuccess=function(i){n=i.target.result,r.clear().onsuccess=function(r){t._done(e,n)}}},_destroy:function(e){var t=this,n=e.schema,r=this._openUserDatabaseForChanges();r.onupgradeneeded=function(e){var t=e.target.result;t.deleteObjectStore(n)},r.onsuccess=function(n){var r=n.target.result;r.close(),t._destroy2(e)}},_destroy2:function(e){var t=this,n=this._name,r=e.schema,i=this._Schemas[r],s=MSQTA._IndexedDB.open("__msqta__",1);s.onsuccess=function(s){var o=s.target.result,u=o.transaction(["databases"],MSQTA._IDBTransaction.READ_WRITE),a=u.objectStore("databases");a.index("name").get(n).onsuccess=function(n){var s=n.target.result;delete s.schemas[r],a.put(s).onsuccess=function(n){t._saveBranch(function(){e.database=o,delete t._Schemas[r],MSQTA._Helpers.dimSchemaInstance(i),this._done(e,!0)},t)}}}},batch:function(e,t,n){var r=this._name,i;(!(e instanceof Array)||!e.length)&&MSQTA._Errors.batch1(r,e),typeof t!="function"&&(t=MSQTA._Helpers.defaultCallback),typeof n!="object"&&(n=window),i={data:e,callback:t,context:n};if(this._isBatchMode){this._batchsStack.push(i);return}this._isBatchMode=!0,this._batch(i)},_batch:function(e){var t=e.data,n=["set","put","del"],r=0,i=t.length,s,o,u,a;for(;r<i;r++)o=t[r],u=o.schema,u instanceof MSQTA._Schema||MSQTA._Errors.batch2(u),a=o.type.toLowerCase(),n.indexOf(a)===-1&&MSQTA._Errors.batch3(a),this._queries=this._queries.concat({schema:u._name,type:a,data:u[a](o.data),callback:MSQTA._Helpers.noop,context:window});s=this._queries[this._queries.length-1],s.callback=e.callback,s.context=e.context,this._isBatchMode=!1,this._isWaiting||this._continue()},destroy:function(e,t){typeof e!="function"&&(e=MSQTA._Helpers.noop),this._deleteUserDatabase(e,t)}},MSQTA._Schema.IndexedDB={_init:function(){var e=this._ORM,t=this._schemaFields,n,r,i={};for(n in t)r=t[n],this._resetSchemaAt(n),i[n]={type:r.type,index:r.index,unique:r.unique};this._schemaKeepTrack=i,e._initSchema(this)},get:function(e,t,n){var r=this._ORM,i=r._name,s=this._schemaFields,o,u={},a=this._name;e||MSQTA._Errors.get(i,a);for(o in s)u[o]=this._getValueBySchema(o,e);var f=function(e,t,n){for(var r in e)if(e[r]===n[r])return!0;return!1};this.devMode&&console.log('MSQTA-ORM: fetching record(s) from "'+a+'" schema from the "'+i+'" database'),this._getAll({callback:f,comparator:u,fields:null},t,n)},getAll:function(e,t){var n=this._ORM,r=n._name,i=this._name,s=function(){return!0};this.devMode&&console.log('MSQTA-ORM: fetching all records from "'+i+'" schema from the "'+r+'" database'),this._getAll({callback:s,comparator:null,fields:null},e,t)},getWithLike:function(e,t,n,r){var i=this._ORM,s=i._name,o=this._schemaFields,u=this._name,a,f,l,c,h;typeof t!="object"&&MSQTA._Errors.getWithLike1(),c=Object.keys(t)[0],h=t[c],(!c||!h)&&MSQTA._Errors.getWithLike1(),c==="both"?h=new RegExp(h,"i"):c==="start"?h=new RegExp("^"+h,"i"):c==="end"&&(h=new RegExp(h+"$","i")),e instanceof Array||(e=[e]);for(a=0,f=e.length;a<f;a++)l=e[a],o[l]||MSQTA._Errors.getWithLike2(s,u,l);var p=function(e,t,n){var r,i=0,s=t.length;for(;i<s;i++){r=t[i];if(n.test(e[r]))return!0}return!1};this.devMode&&console.log('MSQTA-ORM: fetching record(s) from "'+u+'" schema from the "'+s+'" database with like'),this._getAll({callback:p,comparator:h,fields:e},n,r)},getByCallback:function(e,t,n){var r=this._ORM,i=r._name,s=this._name;typeof e!="function"&&MSQTA._Errors.getByCallback(i,s),this.devMode&&console.log('MSQTA-ORM: fetching record(s) from "'+s+'" schema from the "'+i+'" database by "callback"'),this._getAll({callback:e,comparator:null,fields:null},t,n)},_getAll:function(e,t,n){var r={filterData:e,callback:t||MSQTA._Helpers.defaultCallback,context:n||window,self:this};(function(e){var t=e.self,n=t._ORM,r=n._openUserDatabase(),i,s=n._name,o=t._name,u=e.filterData,a=u.callback,f=u.comparator,l=u.fields,c=[];r.onsuccess=function(t){var n=t.target.result,r=n.transaction([o],MSQTA._IDBTransaction.READ_ONLY);objectStore=r.objectStore(o),i=n,objectStore.openCursor().onsuccess=function(t){var n=t.target.result,r;n?(r=n.value,a(r,l,f)&&c.push(r),n.continue()):(i.close(),e.callback.call(e.context,c))}}})(r)},getByIndex:function(e,t,n,r){var i=this._ORM,s=i._name,o=this._name,u={},a=[],f,l,c,h,p;this._primaryKey!==e&&this._indexes.indexOf(e)===-1&&MSQTA._Errors.getByIndex1(s,o,e),this._primaryKey===e?u.pk=e:u.index=e,t||MSQTA._Errors.getByIndex2(s,o),t instanceof Array||(t=[t]),this.devMode&&console.log('MSQTA-ORM: fetching record(s) from "'+o+'" schema from the "'+s+'" database using '+(u.pk?'primary key: "'+u.pk+'"':'index: "'+u.index+'"'));if(t.length===1)u.keyRange=MSQTA._IDBKeyRange.only(this._getValueBySchema(e,t[0])),this._getWithIDBKeyRange(u,n,r);else{for(h=0,p=t.length;h<p;h++)l=t[h],c=this._getValueBySchema(e,l),a.push(c);f=function(e,t,n){for(var r=0,i=t.length;r<i;r++)if(t[r]===e[n])return!0;return!1},this._getAll({callback:f,comparator:u.pk||u.index,fields:a},n,r)}},getByIndexWithRange:function(e,t,n,r){var i=this._ORM,s=i._name,o=this._name,u=this._schemaFields,a=/^(?:>|<|>=|<=|=)$/,f,l={},c={},h,p,d=u[e],v,m;this._primaryKey!==e&&this._indexes.indexOf(e)===-1&&MSQTA._Errors.getByIndexWithRange1(s,o,e),this._primaryKey===e?l.pk=e:l.index=e,v=t["="],v&&d.isDate&&(t={">=":v,"<=":v});for(f in t)a.test(f)||MSQTA._Errors.getByIndexWithRange2(f),v=t[f],m=this._getValueBySchema(e,v),!m&&m!==d.zero&&MSQTA._Errors.getByIndexWithRange3(s,o,v,m),c[f]=m;h=Object.keys(c).length;if(h===2)try{c[">"]&&c["<"]?p=MSQTA._IDBKeyRange.bound(c[">"],c["<"],!0,!0):c[">="]&&c["<="]?p=MSQTA._IDBKeyRange.bound(c[">="],c["<="]):c[">"]&&c["<="]?p=MSQTA._IDBKeyRange.bound(c[">"],c["<="],!0,!1):p=MSQTA._IDBKeyRange.bound(c[">="],c["<"],!1,!0)}catch(g){MSQTA._Errors.getByIndexWithRange5()}else h===1&&(c[">"]?p=MSQTA._IDBKeyRange.lowerBound(c[">"],!0):c[">="]?p=MSQTA._IDBKeyRange.lowerBound(c[">="]):c["<"]?p=MSQTA._IDBKeyRange.upperBound(c["<"],!0):c["<="]?p=MSQTA._IDBKeyRange.upperBound(c["<="]):p=MSQTA._IDBKeyRange.only(c["="]));p||MSQTA._Errors.getByIndexWithRange4(),l.keyRange=p,this.devMode&&console.log('MSQTA-ORM: fetching record(s) from "'+o+'" schema from the "'+s+'" database using '+(l.pk?'primary key: "'+l.pk+'"':'index: "'+l.index+'"')+" with range"),this._getWithIDBKeyRange(l,n,r)},_getWithIDBKeyRange:function(e,t,n){var r={range:e,callback:t||MSQTA._Helpers.defaultCallback,context:n||window,self:this};(function(e){var t=e.self,n=t._ORM,r=e.range,i=r.pk,s=r.index,o=r.keyRange,u=n._openUserDatabase(),a,f=n._name,l=t._name,c=[],h=function(t){var n=t.target.result;n?(c.push(n.value),n.continue()):(a.close(),e.callback.call(e.context,c))};u.onsuccess=function(e){var t=e.target.result,n=t.transaction([l],MSQTA._IDBTransaction.READ_ONLY);objectStore=n.objectStore(l),a=t,i?objectStore.openCursor(o).onsuccess=h:objectStore.index(s).openCursor(o).onsuccess=h}})(r)},put:function(e,t,n){var r=this._ORM,i=r._name,s=this._fieldsName,o,u=this._primaryKey,a=this._name,f,l,c,h,p=s.length;!(e instanceof Array)&&typeof e=="object"&&(e=[e]);for(l=0,c=e.length;l<c;l++){f=e[l];for(h=0;h<p;h++)o=s[h],f[o]=this._getValueBySchema(o,f[o]),delete f[u]}if(r._isBatchMode)return e;r._preExec({type:"put",schema:a,data:e,callback:t,context:n})},set:function(e,t,n){var r=this._ORM,i=this._name,s=this._schemaFields,o=r._name,u,a,f,l,c,h,p={},d={},v=[],m,g;(!e||typeof e!="object")&&MSQTA._Errors.set1(o,i,e),e instanceof Array||(e=[e]);for(m=0,g=e.length;m<g;m++){a=e[m],(!a.data||typeof a.data!="object"||!Object.keys(a.data).length)&&MSQTA._Errors.set2(o,i,a.data),a.target?(typeof a.target!="object"||!Object.keys(a.target).length)&&MSQTA._Errors.set3(o,i,a.target):a.target=[],f=a.target;for(c in f)h=f[c],parsedValue=this._getValueBySchema(c,h),!parsedValue&&parsedValue!==s[c].zero&&MSQTA._Errors.set4(o,i,c,h,parsedValue),p[c]=parsedValue;l=a.data;for(c in l)h=l[c],parsedValue=this._getValueBySchema(c,h),!parsedValue&&parsedValue!==s[c].zero&&MSQTA._Errors.set5(o,i,c,h,parsedValue),d[c]=parsedValue;v.push({data:d,target:p}),d={},p={}}if(r._isBatchMode)return v;r._preExec({type:"set",schema:i,indexes:this._indexes,primaryKey:this._primaryKey,data:v,callback:t,context:n})},del:function(e,t,n){var r=this._ORM,i=r._name,s=this._primaryKey,o=this._name,u,a,f,l=[],c,h;s||MSQTA._Errors.del1(i,o),e||MSQTA._Errors.del2(i,o),e instanceof Array||(e=[e]);for(c=0,h=e.length;c<h;c++)u=e[c],a=this._getValueBySchema(s,u),a||MSQTA._Errors.del3(i,o,u,a),f={},f[s]=a,l.push(f);if(r._isBatchMode)return l;r._preExec({type:"del",schema:o,primaryKey:s,data:l,callback:t,context:n})},destroy:function(e,t){var n=this._ORM,r=n._name,i=this._name;this.devMode&&console.log('MSQTA-ORM: destroying "'+i+'" from the "'+r+'" database'),n._preExec({type:"destroy",schema:i,callback:e,context:t})},empty:function(e,t){var n=this._ORM,r=n._name,i=this._name;this.devMode&&console.log('MSQTA-ORM: emptying "'+i+'" from the "'+r+'" database'),n._preExec({type:"empty",schema:i,callback:e,context:t})}},MSQTA._ORM.WebSQL={Schema:function(e){return MSQTA._Helpers.instantiateSchema({ORM:this.constructor._ORM,schemaPrototype:MSQTA._Schema.WebSQL,schemaDefinition:e,implementation:"webSQL",args:arguments})},_open:function(){(function(e){e._testigoDB=window.openDatabase("__msqta__",1,"",MSQTA._Helpers.webSQLSize),e._testigoDB.transaction(function(t){t.executeSql("CREATE TABLE IF NOT EXISTS databases( id INTEGER PRIMARY KEY, name TEXT UNIQUE, schemas TEXT )"),t.executeSql('SELECT * FROM databases WHERE name = "'+e._name+'"',[],function(t,n){e._open2(n)})})})(this)},_open2:function(e){var t=e.rows;this._schemasDefinition=t.length?JSON.parse(t.item(0).schemas):{},this._errorQueries=[],this._queriesInternal=[],this._userDB=window.openDatabase(this._name,1,"",MSQTA._Helpers.webSQLSize),this._initCallback&&this._initCallback.call(this.initContext||window),this._initSchemas()},_initSchema:function(e){this._schemasToInit.push(e),this._isBlocked||this._initSchemas()},_initSchemas:function(){var e=this,t=this._name;this._schemasToInit.length?this._schemasToInit.shift()._init2():this._endSchemasInitialization()},_endSchemasInitialization:function(){this._isBlocked=!1},_saveSchemaOnTestigoDatabase:function(e,t){var n=this,r=this._name,i=this._schemasDefinition;this.devMode&&console.log("MSQTA-ORM: saving schema definition in the testigo database to keep tracking future changes on it"),this._testigoDB.transaction(function(n){n.executeSql('REPLACE INTO databases( name, schemas ) VALUES( "'+r+'", '+"'"+JSON.stringify(i)+"'"+")",[],function(){e.call(t)})})},_deleteUserDatabase:function(e,t){this.destroy(e,t)},_deleteUserSchema:function(e,t){var n=e._name;delete this._Schemas[n],MSQTA._Helpers.dimSchemaInstance(e),this._saveSchemaOnTestigoDatabase(t.userCallback,t.userContext)},_error:function(e){console.error("MSQTA-ORM: query has failed: \n	code: "+e.code+"\n	"+"message: "+e.message),this._results(!1)},_transaction:function(e){var t=e.userCallback,n=e.userContext;if(t&&typeof t!="function")throw Error("MSQTA-ORM: supplied callback is not a function: ",t);t||(e.userCallback=MSQTA._Helpers.defaultCallback);if(n&&typeof n!="object")throw Error("MSQTA-ORM: supplied context is not an object: ",n);n||(e.userContext=window);if(this._isWaiting){e.isInternal?this._queriesInternal.push(e):this._queries.push(e);return}this._isWaiting=!0,this._transaction2(e)},_transaction2:function(e){this._lastQuery=e;var t=this,n=e.query;n instanceof Array||(n=[n]);var r=function(e,n){t._results(n)},i=function(e,n){t._error(n)};this._userDB.transaction(function(e){var s,o=n.length;while(o--)s=n.shift(),t.devMode&&console.log("MSQTA-ORM: executing the query: \n	"+s),e.executeSql(s,[],o?MSQTA._Helpers.noop:r,i)})},_results:function(e){queryData=this._lastQuery,this._isWaiting=!1,e||(e=!1),queryData.callback&&queryData.context?queryData.callback.call(queryData.context,e,queryData):queryData.userCallback.call(queryData.userContext,queryData.isInsert?e.insertId:e.rowsAffected),this._continue()},_continue:function(){this._isWaiting||(this._queriesInternal.length?this._transaction(this._queriesInternal.shift()):this._queries.length&&this._transaction(this._queries.shift()))},batch:function(e,t,n){var r=this._name,i;(!(e instanceof Array)||!e.length)&&MSQTA._Errors.batch1(r,e),typeof t!="function"&&(t=MSQTA._Helpers.defaultCallback),typeof n!="object"&&(n=window),i={data:e,callback:t,context:n};if(this._isBatchMode){this._batchsStack.push(i);return}this._isBatchMode=!0,this._batch(i)},_batch:function(e){var t=e.data,n=["set","put","del"],r,i,s,o=0,u=t.length;for(;o<u;o++)r=t[o],i=r.schema,i instanceof MSQTA._Schema||MSQTA._Errors.batch2(i),s=r.type.toLowerCase(),n.indexOf(s)===-1&&MSQTA._Errors.batch3(s),this._queries=this._queries.concat({query:i[s](r.data)});var a=this._queries[this._queries.length-1];a.callback=e.callback,a.context=e.context,this._isBatchMode=!1,this._continue(),this._batchsStack.length&&this._batch(this._batchsStack.shift())},destroy:function(e,t){typeof e!="function"&&(e=MSQTA._Helpers.noop),console.error("MSQTA: destroy: deleting a database is not implemented in webSQL standard and will never do.\n To delete a database you need to do manually."),e.call(t||window)},_addQueryError:function(e){return this._errorQueries.push(e),this._errorQueries.length-0},_removeQueryError:function(e){this._errorQueries.splice(e,1)}},MSQTA._Schema.WebSQL={_init:function(){var e=this._schemaFields,t,n,r=this._ORM,i=r._name,s=this._name,o=[],u=this._primaryKey,a,f={},l,c,h,p,d={};for(n in e)t=e[n],a=[],u===n?a.push("PRIMARY KEY"):(l=t.index,c=t.unique,l&&c?f[n]=this._getIndexUniqueQuery(s,n):c?a.push("UNIQUE"):l&&(f[n]=this._getIndexQuery(s,n))),this._resetSchemaAt(n),d[n]={type:t.type,index:t.index,unique:t.unique},o.push(n+" "+e[n].real+(a.length?" "+a.join(" "):""));h='CREATE TABLE "'+s+'" ( '+o.join(", ")+" )",this._createTableQuery=h,this._schemaKeepTrack=d,this._indexesSQL=f,this._indexesToDelete=[],r._initSchema(this)},_init2:function(){var e=this._ORM,t=e._name,n=this._name,r=this._createTableQuery,i,s,o;this.forceDestroy?(this._isSchemaDropped=!0,i='--MSQTA-ORM: "forceDestroy" flag detected: destroying the "'+n+'" schema from the "'+t+'" ddatabase, then it will recreate again\n	DROP TABLE '+n,e._transaction({query:[i,r],context:this,callback:this._updateSchema5,isQueryInternal:!0})):(this.devMode&&console.log('MSQTA.ORM: checking for schema changes in "'+n+'" from the "'+t+'" datatabase'),o={fields:this._schemaKeepTrack,primaryKey:this._primaryKey},s=e._schemasDefinition[n],s?this._checkSchemaChanges(s,o):(e._schemasDefinition[n]=o,this._ORM._saveSchemaOnTestigoDatabase(this._createSchema,this)))},_getIndexUniqueQuery:function(e,t){return"CREATE UNIQUE INDEX "+e+"_"+t+" ON "+e+" ( "+t+" )"},_getIndexQuery:function(e,t){return"CREATE INDEX "+e+"_"+t+" ON "+e+" ( "+t+" )"},_checkSchemaChanges:function(e,t){var n=this._ORM,r=n._name,i=this._name,s=!1,o=e.fields,u=t.fields,a,f,l,c={},h=this._indexesSQL;for(l in o){a=o[l],f=u[l];if(!f||a.type!==f.type){s=!0;break}a.index&&a.unique?c[l]=this._getIndexUniqueQuery(i,l):a.index&&(c[l]=this._getIndexQuery(i,l))}var p=e.primaryKey,d=t.primaryKey;!s&&(p&&(!d||p!==d)||!p&&d)&&(s=!0);if(s)this.devMode&&console.log("	specified schema differs to the registered one.\n	Starting process to update schema!"),n._schemasDefinition[i]=t,this._ORM._saveSchemaOnTestigoDatabase(this._updateSchema,this);else{var v,m,g=[];for(l in c)v=c[l],m=h[l],(!m||m&&v!==m)&&g.push(l);g.length?(this._indexesToDelete=g,this.devMode&&console.log("	schema is still the same, but its index(s) has been changed.\n	Moving directly to step 6!"),n._schemasDefinition[i]=t,this._ORM._saveSchemaOnTestigoDatabase(this._updateSchema5,this)):(this.devMode&&console.log("	no changes detected on its schema nor its index(s)!"),this._updateSchema7())}},_createSchema:function(){var e=this._ORM,t=this._name,n=e._name,r=this._createTableQuery;this.devMode&&console.log("	updating is not needed it, starting creation process"),e._transaction({query:[r],context:this,callback:this._updateSchema5,isQueryInternal:!0})},_updateSchema:function(){var e=this._ORM,t=this._createTableQuery,n=this._name,r=n+ +(new Date),i=t.replace('CREATE TABLE "'+n+'"','CREATE TABLE "'+r+'"');this._offset=0,this._tempschemaName=r,this.devMode&&console.log('		1) Creating table "'+r+'" (this will be the new one at the end of the process)'),e._transaction({query:[i],context:this,callback:this._updateSchema2,isQueryInternal:!0})},_updateSchema2:function(){var e=this._ORM,t=this._name,n=this._tempschemaName,r=this._offset,i,s=this._schemaFields;this._queryErrorID=e._addQueryError("DROP TABLE "+n),i="SELECT * FROM "+t+" LIMIT "+r+", 500",this.devMode&&console.log('		2) Fetching all rows from old schema "'+t+'" by 500 rows per time'),e._transaction({query:[i],context:this,callback:this._updateSchema3,isQueryInternal:!0})},_updateSchema3:function(e){var t=this._ORM,n=this._schemaFields,r=this._name,i=this._tempschemaName,s=e.rows,o,u,a,f=[],l=[],c=[],h=[],p,d;if(!e)throw Error('MSQTA.ORM: fatal error on "'+r+'", you have to destroy this schema to continue, use the set the param "forceDestroy" when you create this schema in your code to recreate this schema, everything will be lost!');if(!s.length){this.devMode&&console.log('		3) Old schema "'+r+'" has no records on it, moving to next step'),this._updateSchema4();return}o=s.item(0);for(u in o)n[u]&&f.push(u);for(u in n)a=n[u],f.indexOf(u)===-1&&(f.push(u),c.push(a.zero));for(p=0,d=s.length;p<d;p++){o=s.item(p);for(u in o)a=n[u],a&&(a.isJSON?l.push("'"+o[u]+"'"):l.push(a.sanitizer(o[u],a.zero)));h.push("INSERT INTO "+i+" ( "+f.join(", ")+" ) VALUES ( "+l.concat(c).join(", ")+" )"),l=[]}self.devMode&&console.log('		3) Inserting rows from old schema "'+r+'" into the new schema "'+i+'"'),d===500?(this._offset+=500,t._transaction({query:h,context:this,callback:this._updateSchema2,isQueryInternal:!0})):t._transaction({query:h,context:this,callback:this._updateSchema4,isQueryInternal:!0})},_updateSchema4:function(){var e=this._ORM,t=this._name,n="DROP TABLE "+t,r=this._tempschemaName,i="ALTER TABLE "+r+" RENAME TO "+t;this.devMode&&(console.log('		4) Deleting old schema "'+t+'"'),console.log('		5) Renaming new schema "'+r+'" to "'+t+'"')),this._isSchemaDropped=!0,e._transaction({query:[n,i],context:this,callback:this._updateSchema5,isQueryInternal:!0})},_updateSchema5:function(){var e=this._ORM,t=e._name,n=[],r=this._indexesToDelete,i,s=this._indexesSQL;this.devMode&&console.log("		6) Creating/removing index(s) (if there is any one)");if(!this._isSchemaDropped)while(r.length)n.push("DROP INDEX "+t+"_"+r.shift());else delete this._isSchemaDropped;for(i in s)n.push(s[i]);n.length?e._transaction({query:n,context:this,callback:this._updateSchema6,isQueryInternal:!0}):this._updateSchema6()},_updateSchema6:function(){var e=this._ORM;this.devMode&&console.log("		7) Updating schema process has ended successful"),e._removeQueryError(this._queryErrorID),delete this._tempschemaName,delete this._offset,delete this._queryErrorID,delete this._indexesToDelete,this.forceEmpty?this._updateSchema8():this._updateSchema7()},_updateSchema7:function(){var e=this._ORM;delete this._createTableQuery,delete this._indexesSQL,this._initCallback&&this._initCallback.call(this._initContext||window),delete this._initCallback,delete this._initContext,e._initSchemas()},_updateSchema8:function(){var e=this._ORM,t=e._name,n=this._name,r='--MSQTA-ORM: "forceEmpty" flag detected: emptying the "'+n+'" schema from the "'+t+'" database\n	DELETE FROM '+n;e._transaction({query:[r],context:this,callback:this._updateSchema7,isQueryInternal:!0})},get:function(e,t,n){var r=this._ORM,i=this._schemaFields,s,o=r._name,u=this._name,a,f=[];e||MSQTA._Errors.get(o,u);for(s in i)f.push(s+" = "+this._getValueBySchema(s,e));a="SELECT * FROM "+u+" WHERE "+f.join(" OR "),r._transaction({query:a,context:this,callback:this._processResults,userCallback:t,userContext:n})},getByCallback:function(e,t,n){var r=this._ORM,i=this._schemaFields,s,o=this._name,u;typeof e!="function"&&MSQTA._Errors.getByCallback(databaseName,o),u="SELECT * FROM "+o,r._transaction({query:u,context:this,callback:this._getByCallback,userCallback:t,userContext:n,filterCallback:e})},_getByCallback:function(e,t){var n=this._schemaFields,r=e.rows,i=0,s=r.length,o,u,a=t.filterCallback,f,l=[];for(;i<s;i++){o=r.item(i),f={};for(u in o)f[u]=n[u].toJS(o[u]);a(f)&&l.push(f)}t.userCallback.call(t.userContext,l)},getByIndex:function(e,t,n,r){var i=this._ORM,s=i._name,o=this._name,u,a=[],f,l,c,h;this._primaryKey!==e&&this._indexes.indexOf(e)===-1&&MSQTA._Errors.getByIndex1(s,o,e),t||MSQTA._Errors.getByIndex2(s,o),t instanceof Array||(t=[t]);for(c=0,h=t.length;c<h;c++)f=t[c],l=this._getValueBySchema(e,f),a.push(e+" = "+l);u="SELECT * FROM "+o+(a.length?" WHERE "+a.join(" OR "):""),i._transaction({query:u,context:this,callback:this._processResults,userCallback:n,userContext:r})},getByIndexWithRange:function(e,t,n,r){var i=this._ORM,s=i._name,o=this._name,u=this._schemaFields,a=/^(?:>|<|>=|<=|=)$/,f,l=[],c,h,p;this._primaryKey!==e&&this._indexes.indexOf(e)===-1&&MSQTA._Errors.getByIndexWithRange1(s,o,e);for(f in t)a.test(f)||MSQTA._Errors.getByIndexWithRange2(f),c=t[f],h=this._getValueBySchema(e,c),!h&&h!==u[e].zero&&MSQTA._Errors.getByIndexWithRange3(s,o,c,h),l.push(e+" "+f+" "+h);l.length||MSQTA._Errors.getByIndexWithRange4(),p="SELECT * FROM "+o+" WHERE "+l.join(" AND "),i._transaction({query:p,context:this,callback:this._processResults,userCallback:n,userContext:r})},getAll:function(e,t){var n=this._ORM,r=this._name,i="SELECT * FROM "+r;n._transaction({query:i,context:this,callback:this._processResults,userCallback:e,userContext:t})},getWithLike:function(e,t,n,r){var i=this._ORM,s=i._name,o=this._schemaFields,u=this._name,a,f,l,c,h;selectAllQueryWithLike,whereClause=[],typeof t!="object"&&MSQTA._Errors.getWithLike1(),c=Object.keys(t)[0],h=t[c],(!c||!h)&&MSQTA._Errors.getWithLike1(),c==="both"?h='"%'+h+'%"':c==="start"?h='"'+h+'%"':c==="end"&&(h='"%'+h+'"'),e instanceof Array||(e=[e]);for(a=0,f=e.length;a<f;a++)l=e[a],o[l]||MSQTA._Errors.getWithLike2(s,u,l),whereClause.push(l+" LIKE "+h);selectAllQueryWithLike="SELECT * FROM "+u+" WHERE "+whereClause.join(" OR "),i._transaction({query:selectAllQueryWithLike,context:this,callback:this._processResults,userCallback:n,userContext:r})},_processResults:function(e,t){var n=this._schemaFields,r=e.rows,i=0,s=r.length,o,u,a,f=[];for(;i<s;i++){o=r.item(i),a={};for(u in o)a[u]=n[u].toJS(o[u]);f.push(a)}t.userCallback.call(t.userContext,f)},put:function(e,t,n){var r=this._ORM,i=r._name,s=this._fieldsName,o,u=this._name,a,f,l=[],c,h,p;!(e instanceof Array)&&typeof e=="object"&&(e=[e]);for(h=0,p=e.length;h<p;h++){c=e[h],a=[],f=[];for(o in c)s.indexOf(o)===-1&&MSQTA._Errors.put1(i,u,o),a.push(o),f.push(this._getValueBySchema(o,c[o]));a.length||MSQTA._Errors.put2(i,u),l.push("INSERT INTO "+u+" ( "+a.join(", ")+" ) "+"VALUES ( "+f.join(" , ")+" )")}if(r._isBatchMode)return l;r._transaction({query:l,userCallback:t,userContext:n,isInsert:!0})},set:function(e,t,n){var r=this._ORM,i=this._name,s=r._name,o=this._schemaFields,u,a,f,l,c,h,p=[],d=[],v=[],m,g;(!e||typeof e!="object")&&MSQTA._Errors.set1(s,i,e),e instanceof Array||(e=[e]);for(m=0,g=e.length;m<g;m++){a=e[m],(!a.data||typeof a.data!="object"||!Object.keys(a.data).length)&&MSQTA._Errors.set2(s,i,a.data),a.target?(typeof a.target!="object"||!Object.keys(a.target).length)&&MSQTA._Errors.set3(s,i,a.target):a.target=[],f=a.target;for(c in f)h=f[c],parsedValue=this._getValueBySchema(c,h),parsedValue||MSQTA._Errors.set4(s,i,c,h,parsedValue),p.push(c+" = "+parsedValue);l=a.data;for(c in l)h=l[c],parsedValue=this._getValueBySchema(c,h),!parsedValue&&parsedValue!==o[c].zero&&MSQTA._Errors.set5(s,i,c,h,parsedValue),d.push(c+" = "+parsedValue);v.push("UPDATE "+i+" SET "+d.join(", ")+(p.length?" WHERE "+p.join(" AND "):"")),d=[],p=[]}if(r._isBatchMode)return v;r._transaction({query:v,userCallback:t,userContext:n})},del:function(e,t,n){var r=this._ORM,i=r._name,s=this._primaryKey,o=this._name,u,a,f,l=[],c,h;s||MSQTA._Errors.del1(i,o),e||MSQTA._Errors.del2(i,o),e instanceof Array||(e=[e]);for(c=0,h=e.length;c<h;c++)u=e[c],a=this._getValueBySchema(s,u),a||MSQTA._Errors.del3(i,o,u,a),l.push(s+" = "+a);f="DELETE FROM "+o+(l.length?" WHERE "+l.join(" OR "):"");if(r._isBatchMode)return[f];r._transaction({query:f,primaryKey:s,userCallback:t,userContext:n})},destroy:function(e,t){var n=this._ORM,r=this._name,i="DROP TABLE "+r;n._transaction({callback:this._destroy,context:this,query:i,userCallback:e,userContext:t})},_destroy:function(e,t){var n=this._ORM;e&&n._deleteUserSchema(this,t)},empty:function(e,t){var n=this._ORM,r=this._name,i="DELETE FROM "+r;n._transaction({query:i,userCallback:e,userContext:t})}}